{% extends 'base.html' %}
{% block content %}
<div class="container mt-5 text-center">
    <h2>Welcome, {{ username }}!</h2>
    <p>Explore the interactive map below:</p>
    <div id="map" style="height: 600px; width: 100%;"></div>
</div>

<!-- Include Leaflet -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Initialize the map
        const map = L.map("map").setView([20, 0], 2); // Default global view

        // Add base map tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
            attribution: "Â© OpenStreetMap",
        }).addTo(map);

        let marker; // Variable to hold the marker

        // Check for query parameters from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const lat = parseFloat(urlParams.get("lat"));
        const lon = parseFloat(urlParams.get("lon"));

        if (!isNaN(lat) && !isNaN(lon)) {
            // If lat and lon exist, add a marker and center the map
            marker = L.marker([lat, lon]).addTo(map)
                .bindPopup(`
                    <b>Favorite Location:</b><br>
                    Latitude: ${lat}<br>
                    Longitude: ${lon}
                `)
                .openPopup();
            map.setView([lat, lon], 12); // Center the map at the given location
        }

        // Handle map clicks
        map.on("click", (e) => {
            const clickedLat = e.latlng.lat.toFixed(4); // Latitude
            const clickedLon = e.latlng.lng.toFixed(4); // Longitude

            // Remove any existing marker
            if (marker) {
                map.removeLayer(marker);
            }

            // Add a new marker at the clicked location
            marker = L.marker([clickedLat, clickedLon]).addTo(map)
                .bindPopup(`
                <b>Selected Location:</b><br>
                Latitude: ${clickedLat}<br>
                Longitude: ${clickedLon}<br>
                <button id="addToFavorites" class="btn btn-primary btn-sm mt-2">
                    Add to Favorites
                </button>
            `)
                .openPopup();

            // Add event listener for the "Add to Favorites" button
            setTimeout(() => {
                document.getElementById("addToFavorites").addEventListener("click", () => {
                    addToFavorites(clickedLat, clickedLon);
                });
            }, 100);
        });

        // Function to add location to favorites
        function addToFavorites(lat, lon) {
            const name = prompt("Enter a name for this favorite location:", "My Favorite Place");
            if (!name) {
                alert("Name is required to save the location.");
                return;
            }

            fetch("/favorites", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    name: name,
                    lat: parseFloat(lat),
                    lon: parseFloat(lon),
                }),
            })
                .then((response) => response.json())
                .then((data) => {
                    alert(data.message || "Added to favorites successfully!");
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("Failed to add location to favorites.");
                });
        }
    });
</script>
{% endblock %}